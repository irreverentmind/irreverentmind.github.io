<!doctype html>
<html class="no-js">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1" />

	<title>Judy Cohen's Mind-Tickler Blog</title>

    <meta name="theme-version" content="1.4.2" />
    <meta name="foundation-version" content="5.5.2" />
    <meta name="jquery-version" content="2.1.4" />
    <meta name="modernizr-version" content="2.8.3" />

	<!-- Foundation Theme for RapidWeaver by Joe Workman -->

	
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="Keywords" content=""no self", certified facilitator, advaita, nonduality, inquiry, depression, anxiety, addiction, "The Work of Byron Katie", "Byron Katie", spirituality" />
		<meta name="Description" content="Irreverent Mind. Practical nonduality for difficult and everyday life situations &copy; 2009-2017  Judy Cohen " />
		<meta name="robots" content="index, follow" />
		<meta name="generator" content="RapidWeaver" />
		

	<link rel="stylesheet" type="text/css" media="all" href="../rw_common/themes/foundation/consolidated.css" />
		
	<script>var foundation={};</script>

	

	<!--[if lt IE 9]>
	  <script src="../rw_common/themes/foundation/ie8.js"></script>
	<![endif]-->

			<link rel='stylesheet' type='text/css' media='all' href='../rw_common/plugins/stacks/stacks.css' />
		<link rel='stylesheet' type='text/css' media='all' href='files/stacks_page_page11.css' />
		<script type='text/javascript' charset='utf-8' src='../rw_common/plugins/stacks/jquery-2.2.4.min.js'></script>
		<link rel="stylesheet" href="../rw_common/plugins/stacks/font-awesome.min.css">
		
		<script type='text/javascript' charset='utf-8' src='files/stacks_page_page11.js'></script>
		<meta class="stacks3 stack version" id="com.joeworkman.stacks.foundation.divider.s3" name="Divider" content="1.7.14">
		<meta class="stacks3 stack version" id="com.joeworkman.stacks.foundation.styles.s3" name=" Site Styles" content="1.7.14">
		<meta class="stacks3 stack version" id="com.blueballdesign.rwwriter" name="RW/Writer" content="2.2.0">
		<meta class="stacks3 stack version" id="com.joeworkman.stacks.foundation.1col.s3" name="1 Column Foundation" content="1.7.14">
		



	
</head>

<body class="antialiased">

<div id="foundation-loader"></div>
<script>
if(window.foundationloader === true){
var loader_inner = document.createElement('div'),
loader_class = window.loader_class||'line-scale',
loader_count = window.loader_count||5;
loader_inner.className = 'loader-inner '+loader_class;
for (var i = 0; i < loader_count; i++){loader_inner.appendChild(document.createElement('div'));}
document.getElementById('foundation-loader').appendChild(loader_inner);}
</script>


<div id='stacks_out_1_page11' class='stacks_top'><div id='stacks_in_1_page11' class=''>  <!--[if lt IE 9]><meta http-equiv="refresh" content="0; url="><![endif]-->   

<div id='stacks_out_6_page11' class='stacks_out'><div id='stacks_in_6_page11' class='stacks_in com_yourhead_stacks_two_columns_stack'><div class='s3_row'>
	<div class='s3_column s3_column_left'><div id='stacks_out_4_page11' class='stacks_out'><div id='stacks_in_4_page11' class='stacks_in image_stack'>
<div class='centered_image' >
    <img class='imageStyle' src='files/stacks-image-fbcbb0e-264x174.jpg' alt='Stacks Image 5'  srcset='files/stacks-image-fbcbb0e-264x174.jpg 1x, files/stacks-image-fbcbb0e-264x174@2x.jpg 2x' />
</div>

</div></div></div>
	<div class='s3_column s3_column_right'><div id='stacks_out_9_page11' class='stacks_out'><div id='stacks_in_9_page11' class='stacks_in image_stack'>
<div class='centered_image' >
    <img class='imageStyle' src='files/judys-mind-tickler.jpg' alt='Stacks Image 10' />
</div>

</div></div></div>
</div></div></div><div id='stacks_out_16_page11' class='stacks_out'><div id='stacks_in_16_page11' class='stacks_in com_joeworkman_stacks_foundation_1col_s3_stack'>

<div class='row        '
><div class='columns small-12   '> <div id='stacks_out_15_page11' class='stacks_out'><div id='stacks_in_15_page11' class='stacks_in com_joeworkman_stacks_foundation_divider_s3_stack'>

<hr class="custom"/>

</div></div></div></div>

</div></div><div id='stacks_out_23_page11' class='stacks_out'><div id='stacks_in_23_page11' class='stacks_in stack_stack'><div id='stacks_out_2_page11' class='stacks_out'><div id='stacks_in_2_page11' class='stacks_in com_blueballdesign_rwwriter_stack'>

<?php

if (version_compare(phpversion(), '5.2.0', '<')) {
    echo "<p>RW/Writer requires PHP 5.2.0 or newer. Ask your web host to upgrade your PHP installation.</p>";
    exit;
}

if (extension_loaded('openssl') === false || (extension_loaded('curl') === false && extension_loaded('sockets') === false)) {
    echo "<p>RW/Writer requires the 'openssl' PHP extension and either the 'curl' or 'sockets' PHP extension. Ask your web host to enable these PHP extensions.</p>";
    exit;
}

@date_default_timezone_set(date_default_timezone_get());

define('API_SCHEME', 'https');
define('API_HOST', 'rwwriter.com');
define('API_KEY', '44bc2270-1c7d-40d5-9b56-6d873e622aa4 ');
define('API_CACHE_BUCKET', 'writer.blueballdesign.com');

define('STACK_SHOW_SIDEBAR', true);
define('STACK_SHOW_TITLE', false);
define('STACK_SHOW_DESCRIPTION', true);
define('STACK_SHOW_RSS', true);
define('STACK_SHOW_CATEGORIES', true);
define('STACK_SHOW_ARCHIVES', true);
define('STACK_RSS_TITLE', 'Subscribe');
define('STACK_RSS_ICON', 'fa fa-rss');
define('STACK_CATEGORIES_TITLE', '');
define('STACK_CATEGORIES_ICON', '');
define('STACK_ARCHIVES_TITLE', 'Archives');
define('STACK_ARCHIVES_ICON', 'fa fa-calendar');

define('STACK_LIST_PER_PAGE', '10');
define('STACK_LIST_OLDER', 'Older');
define('STACK_LIST_NEWER', 'Newer');
define('STACK_LIST_NO_RESULTS', 'No results were found.');
define('STACK_LIST_SHOW_IMAGE', true);

define('STACK_POST_DATE_FORMAT', 'M d, Y H:i');
define('STACK_POST_USE_SUMMARY', 'summary');
define('STACK_POST_MORE', 'Read More');
define('STACK_POST_DISQUS_SHORTNAME', '');

define('STACK_SHOW_SOCIAL', true);
define('STACK_SHARE_FACEBOOK', true);
define('STACK_SHARE_TWITTER', true);
define('STACK_SHARE_GPLUS', false);
define('STACK_SHARE_LINKEDIN', true);

define('STACK_LOCALE', 'en');

// Localizations
$locale = array(
    'en' => array(
        'Monday' => 'Monday',
        'Tuesday' => 'Tuesday',
        'Wednesday' => 'Wednesday',
        'Thursday' => 'Thursday',
        'Friday' => 'Friday',
        'Saturday' => 'Saturday',
        'Sunday' => 'Sunday',
        'January' => 'January',
        'February' => 'February',
        'March' => 'March',
        'April' => 'April',
        'May' => 'May',
        'June' => 'June',
        'July' => 'July',
        'August' => 'August',
        'September' => 'September',
        'October' => 'October',
        'November' => 'November',
        'December' => 'December',
        'Jan' => 'Jan',
        'Feb' => 'Feb',
        'Mar' => 'Mar',
        'Apr' => 'Apr',
        'May' => 'May',
        'Jun' => 'Jun',
        'Jul' => 'Jul',
        'Aug' => 'Aug',
        'Sep' => 'Sep',
        'Oct' => 'Oct',
        'Nov' => 'Nov',
        'Dec' => 'Dec'
    ),
    'es' => array(
        'Monday' => 'lunes',
        'Tuesday' => 'martes',
        'Wednesday' => 'miercoles',
        'Thursday' => 'jueves',
        'Friday' => 'viernes',
        'Saturday' => 'sabado',
        'Sunday' => 'domingo',
        'January' => 'enero',
        'February' => 'febrero',
        'March' => 'marzo',
        'April' => 'abril',
        'May' => 'mayo',
        'June' => 'junio',
        'July' => 'julio',
        'August' => 'agosto',
        'September' => 'septiembre',
        'October' => 'octubre',
        'November' => 'noviembre',
        'December' => 'diciembre',
        'Jan' => 'enero',
        'Feb' => 'feb',
        'Mar' => 'marzo',
        'Apr' => 'abr',
        'May' => 'mayo',
        'Jun' => 'jun',
        'Jul' => 'jul',
        'Aug' => 'agosto',
        'Sep' => 'sept',
        'Oct' => 'oct',
        'Nov' => 'nov',
        'Dec' => 'dic'
    ),
    'fr' => array(
        'Monday' => 'lundi',
        'Tuesday' => 'mardi',
        'Wednesday' => 'mercredi',
        'Thursday' => 'jeudi',
        'Friday' => 'vendredi',
        'Saturday' => 'samedi',
        'Sunday' => 'dimanche',
        'January' => 'janvier',
        'February' => 'février',
        'March' => 'mars',
        'April' => 'avril',
        'May' => 'mai',
        'June' => 'juin',
        'July' => 'juillet',
        'August' => 'août',
        'September' => 'septembre',
        'October' => 'octobre',
        'November' => 'novembre',
        'December' => 'décembre',
        'Jan' => 'janv',
        'Feb' => 'févr',
        'Mar' => 'mars',
        'Apr' => 'avril',
        'May' => 'mai',
        'Jun' => 'juin',
        'Jul' => 'juil',
        'Aug' => 'août',
        'Sep' => 'sept',
        'Oct' => 'oct',
        'Nov' => 'nov',
        'Dec' => 'déc'
    ),
    'de' => array(
        'Monday' => 'Montag',
        'Tuesday' => 'Dienstag',
        'Wednesday' => 'Mittwoch',
        'Thursday' => 'Donnerstag',
        'Friday' => 'Freitag',
        'Saturday' => 'Samstag',
        'Sunday' => 'Sonntag',
        'January' => 'Januar',
        'February' => 'Februar',
        'March' => 'März',
        'April' => 'April',
        'May' => 'Mai',
        'June' => 'Juni',
        'July' => 'Juli',
        'August' => 'August',
        'September' => 'September',
        'October' => 'Oktober',
        'November' => 'November',
        'December' => 'Dezember',
        'Jan' => 'Jan',
        'Feb' => 'Febr',
        'Mar' => 'März',
        'Apr' => 'Apr',
        'May' => 'Mai',
        'Jun' => 'Juni',
        'Jul' => 'Juli',
        'Aug' => 'Aug',
        'Sep' => 'Sept',
        'Oct' => 'Okt',
        'Nov' => 'Nov',
        'Dec' => 'Dez'
    ),
    'it' => array(
        'Monday' => 'lunedi',
        'Tuesday' => 'martedì',
        'Wednesday' => 'mercoledì',
        'Thursday' => 'giovedi',
        'Friday' => 'venerdì',
        'Saturday' => 'sabato',
        'Sunday' => 'domenica',
        'January' => 'gennaio',
        'February' => 'febbraio',
        'March' => 'marzo',
        'April' => 'aprile',
        'May' => 'maggio',
        'June' => 'giugno',
        'July' => 'luglio',
        'August' => 'agosto',
        'September' => 'settembre',
        'October' => 'ottobre',
        'November' => 'novembre',
        'December' => 'dicembre',
        'Jan' => 'genn',
        'Feb' => 'febbr',
        'Mar' => 'mar',
        'Apr' => 'apr',
        'May' => 'magg',
        'Jun' => 'giugno',
        'Jul' => 'luglio',
        'Aug' => 'ag',
        'Sep' => 'sett',
        'Oct' => 'ott',
        'Nov' => 'nov',
        'Dec' => 'dic'
    ),
    'da' => array(
        'Monday' => 'mandag',
        'Tuesday' => 'tirsdag',
        'Wednesday' => 'onsdag',
        'Thursday' => 'torsdag',
        'Friday' => 'fredag',
        'Saturday' => 'lørdag',
        'Sunday' => 'søndag',
        'January' => 'januar',
        'February' => 'februar',
        'March' => 'marts',
        'April' => 'april',
        'May' => 'maj',
        'June' => 'juni',
        'July' => 'juli',
        'August' => 'agosto',
        'September' => 'settembre',
        'October' => 'oktober',
        'November' => 'november',
        'December' => 'december',
        'Jan' => 'jan',
        'Feb' => 'febr',
        'Mar' => 'marts',
        'Apr' => 'april',
        'May' => 'maj',
        'Jun' => 'juni',
        'Jul' => 'juli',
        'Aug' => 'aug',
        'Sep' => 'sept',
        'Oct' => 'okt',
        'Nov' => 'nov',
        'Dec' => 'dic'
    )
);

function __t($word) {
    global $locale;
    if (isset($locale[STACK_LOCALE]) && isset($locale[STACK_LOCALE][$word])) {
        return $locale[STACK_LOCALE][$word];
    }

    return $word;
}

function __tSearch($text) {
    global $locale;
    if (isset($locale[STACK_LOCALE])) {
        return str_replace(array_keys($locale[STACK_LOCALE]), array_values($locale[STACK_LOCALE]), $text);
    }

    return $text;
}

// Show sidebar?
if (STACK_SHOW_SIDEBAR === false) {
    $showSidebar = false;
} else {
    $showSidebar = (STACK_SHOW_RSS || STACK_SHOW_CATEGORIES || STACK_SHOW_ARCHIVES);
}

if (trim(STACK_POST_DISQUS_SHORTNAME) !== '') {
    define('STACK_SHOW_COMMENTS', true);
} else {
    define('STACK_SHOW_COMMENTS', false);
}

function makeRequest($path) {
    $hasSSL = extension_loaded('openssl');
    $hasCurl = extension_loaded('curl');
    $hasSockets = extension_loaded('sockets');
    $result = false;

    if ($hasSSL && $hasCurl) {
        $result = makeRequestWithCurl(API_SCHEME, API_HOST, $path, $status); // <-- Query API first
        if (!$result || (int)$status !== 200) {
            $response = makeRequestWithCurl('https', 's3.amazonaws.com', getCachePath($path), $status); // <-- Fallback to S3 cache
            $result = ($status === 200) ? $response : false;
        }
    } else if ($hasSSL && $hasSockets) {
        $result = makeRequestWithSocket(API_SCHEME, API_HOST, $path, $status); // <-- Query API first
        if (!$result || (int)$status !== 200) {
            $response = makeRequestWithSocket('https', 's3.amazonaws.com', getCachePath($path), $status); // <-- Fallback to S3 cache
            $result = ($status === 200) ? $response : false;
        }
    } else {
        throw new Exception('Your web host must install the PHP "openssl" extension and either the "curl" or "sockets" extensions.');
    }

    return json_decode($result);
}

function makeRequestWithCurl($scheme, $host, $path, &$status) {
    $url =  $scheme . '://' . $host . $path;
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_TIMEOUT, 3); // seconds to wait in total (connection + response)
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 1);
    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);
    curl_setopt($ch, CURLOPT_HTTPHEADER, array(
        'Accept: application/json',
        'X-Writer-Key: ' . API_KEY
    ));
    $result = curl_exec($ch);
    $status = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    return $result;
}

function makeRequestWithSocket($scheme, $host, $path, &$status) {
    // Get host IP address
    $addr = gethostbyname($host);

    // Open socket stream
    $socketScheme = ($scheme === 'https') ? 'ssl' : 'tcp';
    $port = ($scheme === 'https') ? 443 : 80;
    $client = stream_socket_client("$socketScheme://$addr:$port", $errno, $errorMessage, 3);
    stream_set_timeout($client, 3);
    if ($client === false) {
        throw new Exception("Failed to connect: $errorMessage");
    }

    // Send request
    fwrite($client, sprintf(
        "GET %s HTTP/1.0\r\nHost: %s\r\nAccept: application/json\r\nX-Writer-Key: %s\r\nConnection: close\r\n\r\n",
        $path,
        $host,
        API_KEY
    ));

    // Get response
    $result = stream_get_contents($client);
    fclose($client);

    if (!$result) { // <-- Use weak equality to catch empty response due to timeout
        return false;
    }

    // Extract HTTP body
    $resultParts = explode("\r\n\r\n", $result, 2);
    $resultHeaderLines = explode("\r\n", $resultParts[0]);
    $firstLineParts = explode(" ", $resultHeaderLines[0]);
    $status = (int)$firstLineParts[1];

    return isset($resultParts[1]) ? $resultParts[1] : false;
}

function getCachePath($path) {
    // Exclude invalid query parameters that would create invalid cache hash values
    $parts = parse_url($path);
    $queryParams = isset($parts['query']) ? explode('&', $parts['query']) : array();
    $validParamNames = array('category', 'year', 'month');
    $qs = '';
    foreach ($queryParams as $param) {
        $paramParts = explode('=', $param, 2);
        if (in_array($paramParts[0], $validParamNames)) {
            $qs .= sprintf('%s=%s&', $paramParts[0], $paramParts[1]);
        }
    }
    $cachePath = $parts['path'] . ($qs ? '?' . rtrim($qs, '&') : '');

    return sprintf('/%s/cache/api/%s/%s.json', API_CACHE_BUCKET, API_KEY, sha1($cachePath));
}

function entityDecode($text) {
    return html_entity_decode($text, ENT_QUOTES|ENT_HTML401, 'UTF-8');
}

function getRssLink () {
    // Header
    $headerTitle = entityDecode(STACK_RSS_TITLE);
    if (trim(STACK_RSS_ICON) !== '') {
        $headerTitle = sprintf('<i class="%s"></i>', STACK_RSS_ICON) . $headerTitle;
    }
    $headerLink = makeLink($headerTitle, API_SCHEME . '://' . API_HOST . '/rss/' . API_KEY, 'rw-writer-rss-link');

    // Add to H3
    $h3 = makeH(3, $headerLink, 'rw-writer-rss-title');

    // Container
    $container = makeDiv($h3, 'rw-writer-rss');

    return $container;
}

function getCategoryList () {
    $result = makeRequest('/api/stack/categories');
    if ($result === false || $result->success === false) {
        return '<!-- RW/Writer Failed fetching /api/stack/categories -->';
    }

    // Current category
    $currentCategory = getParam('category');

    // Header
    $headerTitle = entityDecode(STACK_CATEGORIES_TITLE);
    if (trim(STACK_CATEGORIES_ICON) !== '') {
        $headerTitle = sprintf('<i class="%s"></i>', STACK_CATEGORIES_ICON) . $headerTitle;
    }
    $header = makeH(3, $headerTitle, 'rw-writer-categories-title');

    // List items
    $listItems = array();
    foreach ($result->data as $item) {
        $listItems[] = makeLi(makeLink($item->title, sprintf('?category=%s', $item->slug)), $item->slug === $currentCategory ? 'active' : false);
    }

    // List
    $list = makeUl(implode('', $listItems), 'rw-writer-categories-list');

    // Container
    $container = makeDiv($header . $list, 'rw-writer-categories');

    return $container;
}

function getArchiveListWithYears () {
    $result = makeRequest('/api/stack/archive/years');
    if ($result === false || $result->success === false) {
        return '<!-- RW/Writer Failed fetching /api/stack/archive/years -->';
    }

    $currentYear = getParam('year');

    $headerTitle = entityDecode(STACK_ARCHIVES_TITLE);
    if (trim(STACK_ARCHIVES_ICON) !== '') {
        $headerTitle = sprintf('<i class="%s"></i>', STACK_ARCHIVES_ICON) . $headerTitle;
    }
    $header = makeH(3, $headerTitle, 'rw-writer-archive-title');

    // List items
    $listItems = array();
    foreach ($result->data as $item) {
        $listItems[] = makeLi(makeLink($item, sprintf('?year=%s', $item)), (int)$item === (int)$currentYear ? 'active' : false);
    }

    $list = makeUl(implode('', $listItems), 'rw-writer-archive-list');

    $container = makeDiv($header . $list, 'rw-writer-archive');

    return $container;
}

function getArchiveListWithMonths () {
    $result = makeRequest('/api/stack/archive/months');
    if ($result === false || $result->success === false) {
        return '<!-- RW/Writer Failed fetching /api/stack/archive/months -->';
    }

    $currentYear = getParam('year');
    $currentMonth = getParam('month');

    $headerTitle = entityDecode(STACK_ARCHIVES_TITLE);
    if (trim(STACK_ARCHIVES_ICON) !== '') {
        $headerTitle = sprintf('<i class="%s"></i>', STACK_ARCHIVES_ICON) . $headerTitle;
    }
    $header = makeH(3, $headerTitle, 'rw-writer-archive-title');

    $listItems = array();
    foreach ($result->data as $item) {
        $listItems[] = makeLi(makeLink(__t($item->month_name) . ' ' . $item->year, sprintf('?year=%s&month=%s', $item->year, $item->month_number)), (int)$currentMonth === (int)$item->month_number && (int)$currentYear === (int)$item->year ? 'active' : false);
    }

    $list = makeUl(implode('', $listItems), 'rw-writer-archive-list');

    $container = makeDiv($header . $list, 'rw-writer-archive');

    return $container;
}

function getMetaScript($meta) {
    $meta = (array)$meta;
    $output = <<<END
<script>
    (function (jq) {
        var rwTitle = '{{rwTitle}}',
            rwMap = {
                rwDescription: "description",
                rwRobots: "robots",
                rwOgTitle: "og:title",
                rwOgImage: "og:image",
                rwOgType: "og:type",
                rwOgDescription: "og:description",
                rwOgUrl: "og:url",
                rwOgSiteName: "og:site_name",
                rwOgTTL: "og:ttl"
            },
            rwValues = {
                rwDescription: '{{rwDescription}}',
                rwRobots: '{{rwRobots}}',
                rwOgTitle: '{{rwOgTitle}}',
                rwOgImage: '{{rwOgImage}}',
                rwOgType: '{{rwOgType}}',
                rwOgDescription: '{{rwOgDescription}}',
                rwOgUrl: '{{rwOgUrl}}',
                rwOgSiteName: '{{rwOgSiteName}}',
                rwOgTTL: '{{rwOgTTL}}'
            },
            makeMetaTag = function (name, content) {
                return '<meta name="' + name + '" content="' + content + '"/>';
            };

        // Update title
        document.title = rwTitle;

        // Update meta tags
        var head = jq('head');
        for (var rwProperty in rwMap) {
            var metaTagName = rwMap[rwProperty],
                metaTagElement = head.find('meta[name="' + metaTagName + '"]');

            if (metaTagElement.length) {
                metaTagElement.text(rwValues[rwProperty]);
            } else {
                head.append(makeMetaTag(metaTagName, rwValues[rwProperty]));
            }
        }
    })(stacks.jQuery);
</script>
END;

    return str_replace(
        array(
            '{{rwTitle}}',
            '{{rwDescription}}',
            '{{rwRobots}}',
            '{{rwOgTitle}}',
            '{{rwOgImage}}',
            '{{rwOgType}}',
            '{{rwOgDescription}}',
            '{{rwOgUrl}}',
            '{{rwOgSiteName}}',
            '{{rwOgTTL}}'
        ),
        array(
            htmlspecialchars($meta['title'], ENT_QUOTES|ENT_HTML401, 'UTF-8'),
            htmlspecialchars($meta['description'], ENT_QUOTES|ENT_HTML401, 'UTF-8'),
            htmlspecialchars($meta['robots'], ENT_QUOTES|ENT_HTML401, 'UTF-8'),
            htmlspecialchars($meta['og:title'], ENT_QUOTES|ENT_HTML401, 'UTF-8'),
            htmlspecialchars($meta['og:image'], ENT_QUOTES|ENT_HTML401, 'UTF-8'),
            htmlspecialchars($meta['og:type'], ENT_QUOTES|ENT_HTML401, 'UTF-8'),
            htmlspecialchars($meta['og:description'], ENT_QUOTES|ENT_HTML401, 'UTF-8'),
            htmlspecialchars($meta['og:url'], ENT_QUOTES|ENT_HTML401, 'UTF-8'),
            htmlspecialchars($meta['og:site_name'], ENT_QUOTES|ENT_HTML401, 'UTF-8'),
            htmlspecialchars($meta['og:ttl'], ENT_QUOTES|ENT_HTML401, 'UTF-8')
        ),
        $output
    );
}

function getContent() {
    $posts = '';

    // Get all potential query params
    $slug = getParam('post');
    $category = getParam('category');
    $page = getParam('page', 1);
    $year = getParam('year');
    $month = getParam('month');

    if ($slug) {
        $url = '/api/stack/posts/' . $slug;
    } else {
        $url = '/api/stack/posts?page=' . urlencode($page) . '&count=' . STACK_LIST_PER_PAGE;
        if ($category) {
            $url .= '&category=' . urlencode($category);
        } else if ($year && $month) {
            $url .= '&year=' . urlencode($year) . '&month=' . urlencode($month);
        } else if ($year) {
            $url .= '&year=' . urlencode($year);
        }
    }

    $result = makeRequest($url);
    if ($result === false || $result->success === false) {
        return '<!-- RW/Writer Failed fetching /api/stack/posts -->';
    }

    $settings = $result->settings;
    $header = '';
    $title = '';
    $description = '';
    if (STACK_SHOW_TITLE === true && isset($settings->title) && trim($settings->title) !== '') {
        $title = makeH(1, makeLink($settings->title, '?page=1'), 'rw-writer-page-title');
    }
    if (STACK_SHOW_DESCRIPTION === true && isset($settings->description) && trim($settings->description) !== '') {
        $description = makeDiv($settings->description, 'rw-writer-page-description');
    }
    if ($title || $description) {
        $header = makeDiv($title . $description, 'rw-writer-page-header');
    }

    $posts .= $header;
    if ($slug) {
        $posts .= getPostFull($result->data);
    } else {
        if ($result->data) {
            foreach ($result->data as $post) {
                $posts .= getPostPartial($post, STACK_POST_USE_SUMMARY, STACK_LIST_SHOW_IMAGE);
            }

            $posts .= getPaginationLinks($result->pagination);
        } else {
            $posts .= makeDiv(entityDecode(STACK_LIST_NO_RESULTS), 'rw-writer-no-results');
        }
    }

    $posts .= getMetaScript($result->meta);

    return $posts;
}

function getPostPartial($data, $viewMode = 'summary', $showImage = false) {

    $postTitleLink = makeLink($data->title, '?post=' . $data->slug);
    $postTitle = makeH(2, $postTitleLink, 'rw-writer-post-title');

    $metaDate = makeLi(__tSearch(date(STACK_POST_DATE_FORMAT, strtotime($data->published_at))), 'rw-writer-post-date');

    $metaCategories = '';
    if ($data->categories) {
        $metaCategoriesLinks = array();
        foreach ($data->categories as $category) {
            $metaCategoriesLinks[] = makeLink($category->title, '?category=' . urlencode($category->slug));
        }
        $metaCategories = makeLi(implode(', ', $metaCategoriesLinks), 'rw-writer-post-categories');
    }

    $metaComments = '';
    if (STACK_SHOW_COMMENTS) {
        $metaComments = makeLi(makeLink('Comments', sprintf('?post=%s#disqus_thread', $data->slug), 'rw-writer-post-comments'));
    }

    $metaAuthor = '';
    if (property_exists($data, 'author') && $data->author) {
        $metaAuthor = makeLi($data->author, 'rw-writer-post-author');
    }

    $meta = makeUl($metaDate . $metaAuthor . $metaCategories . $metaComments, 'rw-writer-post-meta');

    $header = makeDiv($postTitle . $meta, 'rw-writer-post-header');

    $image = '';
    if (($viewMode === 'full' || $showImage === true) && is_null($data->image) === false) {
        $image = makeDiv(sprintf('<img src="%s" alt="%s"/>', $data->image, $data->title), 'rw-writer-post-image');
    }

    $content = makeDiv($viewMode === 'summary' ? $data->summary : $data->content, 'rw-writer-post-content');

    $moreLink = makeLink(entityDecode(STACK_POST_MORE), '?post=' . $data->slug, 'rw-writer-post-more');

    $shareLinks = '';
    if (STACK_SHOW_SOCIAL) {
        $shareUrl = getPostAbsoluteUrl($data->slug);
        $shareLinks = getShareLinks($shareUrl, $data->title, API_KEY, $data->uuid);
        $shareLinks = makeDiv($shareLinks, 'rw-writer-share');
    }

    $container = makeDiv($header . $image . $content . $moreLink . $shareLinks, 'rw-writer-post ' . ($viewMode === 'summary' ? 'rw-writer-post-partial' : 'rw-writer-post-full'));

    return $container;
}

function getPostFull($data) {

    $postTitle = makeH(2, $data->title, 'rw-writer-post-title');

    $metaDate = makeLi(__tSearch(date(STACK_POST_DATE_FORMAT, strtotime($data->published_at))), 'rw-writer-post-date');

    $metaCategories = '';
    if ($data->categories) {
        $metaCategoriesLinks = array();
        foreach ($data->categories as $category) {
            $metaCategoriesLinks[] = makeLink($category->title, '?category=' . urlencode($category->slug));
        }
        $metaCategories = makeLi(implode(', ', $metaCategoriesLinks), 'rw-writer-post-categories');
    }

    $metaComments = '';
    if (STACK_SHOW_COMMENTS) {
        $metaComments = makeLi(makeLink('Comments', '#disqus_thread', 'rw-writer-post-comments'));
    }

    $metaAuthor = '';
    if (property_exists($data, 'author') && $data->author) {
        $metaAuthor = makeLi($data->author, 'rw-writer-post-author');
    }

    $meta = makeUl($metaDate . $metaAuthor . $metaCategories . $metaComments, 'rw-writer-post-meta');

    $header = makeDiv($postTitle . $meta, 'rw-writer-post-header');

    $image = '';
    if (is_null($data->image) === false) {
        $image = makeDiv(sprintf('<img src="%s" alt="%s"/>', $data->image, $data->title), 'rw-writer-post-image');
    }

    $content = makeDiv($data->content, 'rw-writer-post-content');

    $shareLinks = '';
    if (STACK_SHOW_SOCIAL) {
        $shareUrl = getPostAbsoluteUrl($data->slug);
        $shareLinks = getShareLinks($shareUrl, $data->title, API_KEY, $data->uuid);
        $shareLinks = makeDiv($shareLinks, 'rw-writer-share');
    }

    $container = makeDiv($header . $image . $content . $shareLinks, 'rw-writer-post rw-writer-post-full');

    return $container;
}

function getPostAbsoluteUrl($slug) {
    $scheme = (empty($_SERVER['HTTPS']) || $_SERVER['HTTPS'] === 'off') ? 'http' : 'https';
    $host = $_SERVER['HTTP_HOST'];
    $url = isset($_SERVER['SCRIPT_NAME']) ? $_SERVER['SCRIPT_NAME'] : $_SERVER['PHP_SELF'];

    return sprintf(
        '%s://%s%s?post=%s',
        $scheme,
        $host,
        $url,
        $slug
    );
}

function getPaginationLinks($paginationData) {
    // Build persistent query parameters
    $qParams = array('category', 'year', 'month');
    $qString = '';
    foreach ($qParams as $param) {
        $value = getParam($param);
        if ($value) {
            $qString .= sprintf('&%s=%s', urlencode($param), urlencode($value));
        }
    }

    $newer = '';
    if ($paginationData->page > 1) {
        $newerPage = $paginationData->page - 1;
        $newer = makeLink(
            entityDecode(STACK_LIST_NEWER),
            '?page=' . urlencode($newerPage) . $qString,
            'rw-writer-newer'
        );
    }

    $older = '';
    if ($paginationData->page < $paginationData->page_count) {
        $olderPage = $paginationData->page + 1;
        $older = makeLink(
            entityDecode(STACK_LIST_OLDER),
            '?page=' . urlencode($olderPage) . $qString,
            'rw-writer-older'
        );
    }

    $container = makeDiv($newer . $older, 'rw-writer-pagination');

    return $container;
}

function getShareLinks($url, $text, $blogId, $postId) {
    $links = array();

    // Facebook
    if (STACK_SHARE_FACEBOOK) {
        $links[] = sprintf(
            '<a class="rw-writer-share-link" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=%s"><i class="fa fa-facebook-official"></i></a>',
            urlencode('https://rwwriter.com/share/' . $blogId . '/' . $postId)
        );
    }

    // Twitter
    if (STACK_SHARE_TWITTER) {
        $links[] = sprintf(
            '<a class="rw-writer-share-link" target="_blank" href="https://twitter.com/intent/tweet?text=%s&url=%s"><i class="fa fa-twitter"></i></a>',
            urlencode($text),
            urlencode($url)
        );
    }

    // Google+
    if (STACK_SHARE_GPLUS) {
        $links[] = sprintf(
            '<a class="rw-writer-share-link" target="_blank" href="https://plus.google.com/share?url=%s"><i class="fa fa-google-plus-square"></i></a>',
            urlencode($url)
        );
    }

    // LinkedIn
    if (STACK_SHARE_LINKEDIN) {
        $links[] = sprintf(
            '<a class="rw-writer-share-link" target="_blank" href="https://www.linkedin.com/shareArticle?url=%s&title=%s"><i class="fa fa-linkedin-square"></i></a>',
            urlencode($url),
            urlencode($text)
        );
    }

    return implode("\n", $links);
}

function makeDiv($content, $class = false) {
    if ($content) {
        return sprintf(
            '<div%s>%s</div>',
            $class ? sprintf(' class="%s"', $class) : '',
            $content
        );
    }

    return '';
}

function makeH($level, $content, $class = false) {
    if ($content) {
        return sprintf(
            '<h%s%s>%s</h%s>',
            $level,
            $class ? sprintf(' class="%s"', $class) : '',
            $content,
            $level
        );
    }

    return '';
}

function makeUl($content, $class = false) {
    if ($content) {
        return sprintf(
            '<ul%s>%s</ul>',
            $class ? sprintf(' class="%s"', $class) : '',
            $content
        );
    }

    return '';
}

function makeLi($content, $class = false) {
    if ($content) {
        return sprintf(
            '<li%s>%s</li>',
            $class ? sprintf(' class="%s"', $class) : '',
            $content
        );
    }

    return '';
}

function makeLink($content, $href, $class = false) {
    if ($content) {
        return sprintf(
            '<a href="%s"%s>%s</a>',
            $href,
            $class ? sprintf(' class="%s"', $class) : '',
            $content
        );
    }

    return '';
}

function getParam($name, $default = null) {
    return isset($_GET[$name]) ? $_GET[$name] : $default;
}
?>


<div id="rwwriter_wrapper">
    <div class="rwwriter_content<?php if ($showSidebar === false): ?> rwwriter_content_wide<?php endif; ?>">
        <?php echo getContent(); ?>

        
        <?php if (STACK_SHOW_COMMENTS && isset($_GET['post'])): ?>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = '<?php echo trim(STACK_POST_DISQUS_SHORTNAME); ?>';
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
        <?php endif; ?>
        
    </div>

    <?php if ($showSidebar): ?>
    <div class="rwwriter_sidebar">
        <?php
        if (STACK_SHOW_RSS) {
            echo getRssLink();
        }

        if (STACK_SHOW_CATEGORIES) {
            echo getCategoryList();
        }

        if (STACK_SHOW_ARCHIVES) {
            echo getArchiveListWithMonths();
        }
        ?>
    </div>
    <?php endif; ?>
</div>

<script>
// Enable responsive YouTube videos
(function ($) {
    $('.video-container').each(function () {
        var $container = $(this),
            resizeType = $container.attr('data-resizetype');

        if (resizeType === 'responsive') {
            var maxHeight = $container.attr('data-maxheight'),
                maxWidth = $container.attr('data-maxwidth'),
                heightIsPixels = (maxHeight.indexOf('%') === -1),
                widthIsPixels = (maxWidth.indexOf('%') === -1);

            $container
                .addClass('video-container-responsive')
                .children('iframe,object').css({
                    'maxHeight': maxHeight + (heightIsPixels ? 'px' : ''),
                    'maxWidth': maxWidth + (widthIsPixels ? 'px' : '')
                });

            var $iframe = $container.find('iframe'),
                protocol = window.location.protocol;
            if (protocol.indexOf('file') === 0) {
                protocol = 'https:';
            }
            $iframe.attr('src', $iframe.attr('src').replace(/^\/\//, protocol + '//'));
        }
    });
})(stacks.jQuery);
</script>

</div></div></div></div></div></div>



<script src="../rw_common/themes/foundation/foundation.js"></script>


<!--[if lt IE 9]>
  <script src="../rw_common/themes/foundation/ie8rem.js"></script>
<![endif]-->

</body>
</html>
